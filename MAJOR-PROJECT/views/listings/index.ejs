<% layout("/layouts/boilerplate") %>

    <body>
        <div class="container-fluid px-4 main-content">
            <!-- Header & Filter -->
            <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
                <div class="page-header">
                    <% if (typeof search !=='undefined' && search) { %>
                        <h1 class="h3 mb-0">Results for "<%= search %>"</h1>
                        <% } else { %>
                            <h1 class="h3 mb-0">All Listings</h1>
                            <% } %>
                </div>

                <div class="filter-container">
                    <form action="/listings" method="GET" id="filterForm" class="d-flex align-items-center">
                        <% if (typeof search !=='undefined' && search) { %>
                            <input type="hidden" name="search" value="<%= search %>">
                            <% } %>

                                <div class="dropdown">
                                    <button class="btn btn-filter dropdown-toggle" type="button"
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fa-solid fa-sliders me-2"></i>Filters
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end p-3 shadow-lg border-0"
                                        style="min-width: 250px;">
                                        <li>
                                            <h6 class="dropdown-header px-0 text-uppercase small fw-bold">Sort By</h6>
                                        </li>
                                        <li>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="sort" id="sortNewest"
                                                    value="newest" <%=(typeof sort==='undefined' || sort==='newest' )
                                                    ? 'checked' : '' %> onchange="this.form.submit()">
                                                <label class="form-check-label" for="sortNewest">Newest First</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="sort"
                                                    id="sortPriceLow" value="price_asc" <%=sort==='price_asc'
                                                    ? 'checked' : '' %> onchange="this.form.submit()">
                                                <label class="form-check-label" for="sortPriceLow">Price: Low to
                                                    High</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="sort"
                                                    id="sortPriceHigh" value="price_desc" <%=sort==='price_desc'
                                                    ? 'checked' : '' %> onchange="this.form.submit()">
                                                <label class="form-check-label" for="sortPriceHigh">Price: High to
                                                    Low</label>
                                            </div>
                                        </li>
                                        <li>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="sort" id="sortRating"
                                                    value="rating_desc" <%=sort==='rating_desc' ? 'checked' : '' %>
                                                onchange="this.form.submit()">
                                                <label class="form-check-label" for="sortRating">Top Rated</label>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                    </form>
                </div>
            </div>

            <% if (typeof allListings !=='undefined' && allListings.length===0) { %>
                <div class="alert alert-info" role="alert">
                    <i class="fa-solid fa-circle-info me-2"></i> No listings found matching your criteria.
                </div>
                <% } else { %>
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4">
                        <% for(let listing of allListings){ %>
                            <div class="col">
                                <a href="/listings/<%=listing._id%>" class="text-decoration-none">
                                    <div class="card h-100 listing-card">
                                        <div class="card-img-container">
                                            <img src="<%=listing.image.url %>" class="card-img-top"
                                                alt="<%=listing.title%>">
                                            <div class="card-badge">Guest favourite</div>
                                            <div class="card-heart">
                                                <i class="fa-regular fa-heart"></i>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <h5 class="card-title">
                                                    <%=listing.title%>
                                                </h5>
                                                <% if (listing.avgRating) { %>
                                                    <div class="rating-compact">
                                                        <i class="fa-solid fa-star"></i>
                                                        <span>
                                                            <%= listing.avgRating.toFixed(1) %>
                                                        </span>
                                                    </div>
                                                    <% } %>
                                            </div>
                                            <p class="card-text location-text">
                                                <% if (listing.location && listing.location.city) { %>
                                                    <%= listing.location.city %>, <%= listing.location.country %>
                                                            <% } else { %>
                                                                <%= listing.location %>, <%= listing.country %>
                                                                        <% } %>
                                            </p>
                                            <p class="card-text price-text">
                                                <strong>&#8377;<%= listing.price ? listing.price.toLocaleString("en-IN")
                                                        : "N/A" %></strong>
                                                <span class="night-text">for 2 nights</span>
                                            </p>
                                        </div>
                                    </div>
                                </a>
                            </div>
                            <% } %>
                    </div>

                    <!-- Pagination Controls -->
                    <% if (typeof totalPages !=='undefined' && totalPages> 1) { %>
                        <nav aria-label="Page navigation" class="mt-5">
                            <ul class="pagination justify-content-center">
                                <li class="page-item <%= currentPage == 1 ? 'disabled' : '' %>">
                                    <a class="page-link"
                                        href="/listings?page=<%= currentPage - 1 %><%= typeof search !== 'undefined' && search ? '&search=' + search : '' %><%= typeof sort !== 'undefined' && sort ? '&sort=' + sort : '' %>"
                                        aria-label="Previous">
                                        <span aria-hidden="true">&laquo;</span>
                                    </a>
                                </li>
                                <% for(let i=1; i <=totalPages; i++) { %>
                                    <li class="page-item <%= currentPage == i ? 'active' : '' %>">
                                        <a class="page-link"
                                            href="/listings?page=<%= i %><%= typeof search !== 'undefined' && search ? '&search=' + search : '' %><%= typeof sort !== 'undefined' && sort ? '&sort=' + sort : '' %>">
                                            <%= i %>
                                        </a>
                                    </li>
                                    <% } %>
                                        <li class="page-item <%= currentPage == totalPages ? 'disabled' : '' %>">
                                            <a class="page-link"
                                                href="/listings?page=<%= currentPage + 1 %><%= typeof search !== 'undefined' && search ? '&search=' + search : '' %><%= typeof sort !== 'undefined' && sort ? '&sort=' + sort : '' %>"
                                                aria-label="Next">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                            </ul>
                        </nav>
                        <% } %>
                            <% } %>
        </div>
    </body>